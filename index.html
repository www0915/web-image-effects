<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVGフィルターデモ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .upload-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #4CAF50;
            background: #f9f9f9;
        }

        .upload-area.dragover {
            border-color: #4CAF50;
            background: #e8f5e9;
        }

        #fileInput {
            display: none;
        }

        .upload-text {
            color: #666;
            font-size: 1.1em;
        }

        .filter-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .filter-demo {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* エッジ検出デモの背景を明るい色に（透過確認用） */
        .filter-demo:nth-child(2),
        .filter-demo:nth-child(3) {
            background: 
                linear-gradient(45deg, #f0f0f0 25%, white 25%),
                linear-gradient(-45deg, #f0f0f0 25%, white 25%),
                linear-gradient(45deg, white 75%, #f0f0f0 75%),
                linear-gradient(-45deg, white 75%, #f0f0f0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        .demo-title {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .filter-target {
            width: 100%;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            transition: all 0.3s ease;
            position: relative;
        }

        .watercolor-image {
            filter: url(#watercolor);
            max-width: 100%;
            height: auto;
        }

        .edge-image {
            filter: url(#edgeDetect);
            max-width: 100%;
            height: auto;
        }

        /* 重ね合わせ用のスタイル */
        .layered-container {
            position: relative;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .watercolor-layer {
            filter: url(#watercolorCombined);
            max-width: 100%;
            height: auto;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
        }

        .edge-layer {
            filter: url(#edgeDetectCombined);
            max-width: 100%;
            height: auto;
            position: relative;
            z-index: 1;
        }

        .controls {
            margin-top: 10px;
        }

        .controls label {
            display: block;
            margin: 5px 0;
            font-size: 0.9em;
        }

        input[type="range"] {
            width: 100%;
        }

        .download-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .download-btn:hover {
            background: #45a049;
        }

        .reset-btn {
            margin-left: 10px;
            padding: 8px 16px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .reset-btn:hover {
            background: #da190b;
        }
    </style>
</head>
<body>
    <!-- SVGフィルターの定義 -->
    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="0" height="0">
        <defs>
            <!-- 水彩画風フィルター -->
            <filter id="watercolor" x="-50%" y="-50%" width="200%" height="200%">
                <feTurbulence type="fractalNoise" baseFrequency="0.01" numOctaves="3" result="noise"/>
                <feDisplacementMap in="SourceGraphic" in2="noise" scale="20" xChannelSelector="R" yChannelSelector="G"/>
                <feGaussianBlur stdDeviation="1"/>
                <feComposite operator="in" in2="SourceGraphic"/>
            </filter>

            <!-- エッジ検出フィルター (feConvolveMatrix) - エッジのみ黒線で表示＋背景透過 -->
            <filter id="edgeDetect" x="-10%" y="-10%" width="120%" height="120%">
                <!-- エッジ検出 -->
                <feConvolveMatrix 
                    id="edgeKernel"
                    order="3" 
                    kernelMatrix="-1 -1 -1
                                  -1  9 -1
                                  -1 -1 -1"
                    result="edges"/>
                
                <!-- 線を太くする -->
                <feMorphology id="edgeThickness" operator="dilate" radius="0" in="edges" result="thickEdges"/>
                
                <!-- エッジ部分を黒に、背景を透明に -->
                <feColorMatrix id="edgeThreshold" in="thickEdges" type="matrix"
                    values="0 0 0 0 0
                            0 0 0 0 0
                            0 0 0 0 0
                            1 1 1 0 -2"
                    result="blackEdges"/>
                
                <!-- 透明度を調整 -->
                <feComponentTransfer id="edgeOpacity" in="blackEdges">
                    <feFuncA type="linear" slope="1"/>
                </feComponentTransfer>
            </filter>

            <!-- 組み合わせ用：水彩画風フィルター -->
            <filter id="watercolorCombined" x="-50%" y="-50%" width="200%" height="200%">
                <feTurbulence id="watercolorNoiseCombined" type="fractalNoise" baseFrequency="0.01" numOctaves="3" result="noise"/>
                <feDisplacementMap in="SourceGraphic" in2="noise" scale="20" xChannelSelector="R" yChannelSelector="G" id="watercolorDisplacementCombined"/>
                <feGaussianBlur stdDeviation="1" id="watercolorBlurCombined"/>
                <feComposite operator="in" in2="SourceGraphic"/>
            </filter>

            <!-- 組み合わせ用：エッジ検出フィルター -->
            <filter id="edgeDetectCombined" x="-10%" y="-10%" width="120%" height="120%">
                <feConvolveMatrix 
                    id="edgeKernelCombined"
                    order="3" 
                    kernelMatrix="-1 -1 -1
                                  -1  9 -1
                                  -1 -1 -1"
                    result="edges"/>
                
                <feMorphology id="edgeThicknessCombined" operator="dilate" radius="0" in="edges" result="thickEdges"/>
                
                <feColorMatrix id="edgeThresholdCombined" in="thickEdges" type="matrix"
                    values="0 0 0 0 0
                            0 0 0 0 0
                            0 0 0 0 0
                            1 1 1 0 -2"
                    result="blackEdges"/>
                
                <!-- 透明度を調整 -->
                <feComponentTransfer id="edgeOpacityCombined" in="blackEdges">
                    <feFuncA type="linear" slope="1"/>
                </feComponentTransfer>
            </filter>
        </defs>
    </svg>

    <h1>SVGフィルターデモ - 画像加工ツール</h1>

    <!-- 画像アップロードエリア -->
    <div class="upload-section">
        <h2>画像をアップロード</h2>
        <div class="upload-area" id="uploadArea">
            <p class="upload-text">クリックまたはドラッグ&ドロップで画像を選択</p>
            <input type="file" id="fileInput" accept="image/*">
        </div>
        <button class="reset-btn" id="resetBtn" style="display: none; margin-top: 10px;">デフォルト画像に戻す</button>
    </div>

    <div class="filter-container">
        <!-- 水彩画風効果のデモ -->
        <div class="filter-demo">
            <h2 class="demo-title">水彩画風効果</h2>
            <div class="filter-target">
                <img id="watercolorImg" src="./images/test.jpg" alt="サンプル画像" class="watercolor-image">
            </div>
            <div class="controls">
                <label>
                    歪み強度:
                    <input type="range" min="0" max="50" value="20" id="watercolorIntensity">
                </label>
                <button class="download-btn" id="downloadWatercolor">ダウンロード</button>
            </div>
        </div>

        <!-- エッジ検出効果のデモ -->
        <div class="filter-demo">
            <h2 class="demo-title">エッジ検出効果 (feConvolveMatrix)</h2>
            <div class="filter-target">
                <img id="edgeImg" src="./images/test.jpg" alt="サンプル画像" class="edge-image">
            </div>
            <div class="controls">
                <label>
                    エッジ強度: <span id="edgeStrengthValue">9</span>
                    <input type="range" min="5" max="15" value="9" step="0.5" id="edgeStrength">
                </label>
                <label>
                    線の太さ: <span id="edgeThicknessValue">0</span>
                    <input type="range" min="0" max="3" value="0" step="1" id="edgeThicknessSlider">
                </label>
                <label>
                    感度: <span id="edgeSensitivityValue">-2</span>
                    <input type="range" min="-4" max="-1" step="0.1" value="-2" id="edgeSensitivity">
                </label>
                <!-- <label>
                    透明度: <span id="edgeOpacityValue">100</span>%
                    <input type="range" min="0" max="100" value="100" step="1" id="edgeOpacity">
                </label> -->
                <button class="download-btn" id="downloadEdge">ダウンロード</button>
            </div>
        </div>

        <!-- エッジ検出 + 水彩画風の組み合わせ -->
        <div class="filter-demo">
            <h2 class="demo-title">エッジ検出 + 水彩画風効果</h2>
            <div class="filter-target">
                <div class="layered-container">
                    <img id="watercolorLayerImg" src="./images/test.jpg" alt="水彩画レイヤー" class="watercolor-layer">
                    <img id="edgeLayerImg" src="./images/test.jpg" alt="エッジレイヤー" class="edge-layer">
                </div>
            </div>
            <div class="controls">
                <label>
                    水彩画歪み: <span id="watercolorCombinedValue">20</span>
                    <input type="range" min="0" max="50" value="20" id="watercolorCombinedSlider">
                </label>
                <label>
                    エッジ強度: <span id="edgeStrengthCombinedValue">9</span>
                    <input type="range" min="5" max="15" value="9" step="0.5" id="edgeStrengthCombined">
                </label>
                <label>
                    エッジ線の太さ: <span id="edgeThicknessCombinedValue">0</span>
                    <input type="range" min="0" max="3" value="0" step="1" id="edgeThicknessCombinedSlider">
                </label>
                <label>
                    エッジ感度: <span id="edgeSensitivityCombinedValue">-2</span>
                    <input type="range" min="-4" max="-1" step="0.1" value="-2" id="edgeSensitivityCombined">
                </label>
                <!-- <label>
                    エッジ透明度: <span id="edgeOpacityCombinedValue">100</span>%
                    <input type="range" min="0" max="100" value="100" step="1" id="edgeOpacityCombined">
                </label> -->
                <button class="download-btn" id="downloadCombined">ダウンロード</button>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_IMAGE = './images/test.jpg';
        let currentImageUrl = DEFAULT_IMAGE;

        // 画像アップロード処理
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const resetBtn = document.getElementById('resetBtn');

        uploadArea.addEventListener('click', () => fileInput.click());

        // ドラッグ&ドロップ
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                loadImage(file);
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                loadImage(file);
            }
        });

        function loadImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                currentImageUrl = e.target.result;
                updateAllImages(currentImageUrl);
                resetBtn.style.display = 'inline-block';
            };
            reader.readAsDataURL(file);
        }

        function updateAllImages(imageUrl) {
            // 水彩画風
            document.getElementById('watercolorImg').src = imageUrl;

            // エッジ検出
            document.getElementById('edgeImg').src = imageUrl;

            // 組み合わせ
            document.getElementById('watercolorLayerImg').src = imageUrl;
            document.getElementById('edgeLayerImg').src = imageUrl;
        }

        // リセット機能
        resetBtn.addEventListener('click', () => {
            currentImageUrl = DEFAULT_IMAGE;
            updateAllImages(DEFAULT_IMAGE);
            resetBtn.style.display = 'none';
            fileInput.value = '';
        });

        // 水彩画風効果の制御
        document.getElementById('watercolorIntensity').addEventListener('input', function(e) {
            const value = e.target.value;
            const filter = document.getElementById('watercolor');
            const displacementMap = filter.querySelector('feDisplacementMap');
            displacementMap.setAttribute('scale', value);
        });

        // エッジ強度の調整（小数点対応）
        document.getElementById('edgeStrength').addEventListener('input', function(e) {
            const value = e.target.value;
            document.getElementById('edgeStrengthValue').textContent = value;
            const kernel = document.getElementById('edgeKernel');
            kernel.setAttribute('kernelMatrix', 
                `-1 -1 -1 -1 ${value} -1 -1 -1 -1`);
        });

        // エッジの線の太さの調整
        document.getElementById('edgeThicknessSlider').addEventListener('input', function(e) {
            const value = e.target.value;
            document.getElementById('edgeThicknessValue').textContent = value;
            const morphology = document.getElementById('edgeThickness');
            morphology.setAttribute('radius', value);
        });

        // エッジ感度の調整
        document.getElementById('edgeSensitivity').addEventListener('input', function(e) {
            const value = e.target.value;
            document.getElementById('edgeSensitivityValue').textContent = value;
            const matrix = document.getElementById('edgeThreshold');
            matrix.setAttribute('values',
                `0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 1 0 ${value}`);
        });

        // エッジ透明度の調整
        document.getElementById('edgeOpacity').addEventListener('input', function(e) {
            const value = e.target.value;
            document.getElementById('edgeOpacityValue').textContent = value;
            const opacity = document.getElementById('edgeOpacity');
            const slope = value / 100; // 0-100を0-1に変換
            opacity.querySelector('feFuncA').setAttribute('slope', slope);
        });

        // 組み合わせ：水彩画歪みの調整
        document.getElementById('watercolorCombinedSlider').addEventListener('input', function(e) {
            const value = e.target.value;
            document.getElementById('watercolorCombinedValue').textContent = value;
            const displacementMap = document.getElementById('watercolorDisplacementCombined');
            displacementMap.setAttribute('scale', value);
        });

        // 組み合わせ：エッジ強度の調整（小数点対応）
        document.getElementById('edgeStrengthCombined').addEventListener('input', function(e) {
            const value = e.target.value;
            document.getElementById('edgeStrengthCombinedValue').textContent = value;
            const kernel = document.getElementById('edgeKernelCombined');
            kernel.setAttribute('kernelMatrix', 
                `-1 -1 -1 -1 ${value} -1 -1 -1 -1`);
        });

        // 組み合わせ：エッジの線の太さの調整
        document.getElementById('edgeThicknessCombinedSlider').addEventListener('input', function(e) {
            const value = e.target.value;
            document.getElementById('edgeThicknessCombinedValue').textContent = value;
            const morphology = document.getElementById('edgeThicknessCombined');
            morphology.setAttribute('radius', value);
        });

        // 組み合わせ：エッジ感度の調整
        document.getElementById('edgeSensitivityCombined').addEventListener('input', function(e) {
            const value = e.target.value;
            document.getElementById('edgeSensitivityCombinedValue').textContent = value;
            const matrix = document.getElementById('edgeThresholdCombined');
            matrix.setAttribute('values',
                `0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 1 0 ${value}`);
        });

        // 組み合わせ：エッジ透明度の調整
        document.getElementById('edgeOpacityCombined').addEventListener('input', function(e) {
            const value = e.target.value;
            document.getElementById('edgeOpacityCombinedValue').textContent = value;
            const opacity = document.getElementById('edgeOpacityCombined');
            const slope = value / 100; // 0-100を0-1に変換
            opacity.querySelector('feFuncA').setAttribute('slope', slope);
        });

        // ダウンロード機能
        function downloadImage(elementId, filename) {
            const element = document.getElementById(elementId);
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = element.naturalWidth;
            canvas.height = element.naturalHeight;
            
            // SVGフィルタを適用した画像をキャンバスに描画
            ctx.filter = getComputedStyle(element).filter;
            ctx.drawImage(element, 0, 0);
            
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            });
        }

        document.getElementById('downloadWatercolor').addEventListener('click', () => {
            downloadImage('watercolorImg', 'watercolor-effect.png');
        });

        document.getElementById('downloadEdge').addEventListener('click', () => {
            downloadImage('edgeImg', 'edge-detect.png');
        });

        document.getElementById('downloadCombined').addEventListener('click', () => {
            downloadImage('edgeLayerImg', 'combined-effect.png');
        });
    </script>
</body>
</html>